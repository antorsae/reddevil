** RUTINA DE MUSICA PARA FICHEROS
** SOUNDTRACKER .MOD
** QUEDAN 4 REGISTROS LIBRES:D6-D7/A5-A6

** (C) ST CONNEXION Y ARREGLADA UN POCO POR RED DEVIL

	CLR.L -(A7)
	MOVE.W #$20,-(A7)
	TRAP #1
	LEA $2000,A7

	BSR MUZAK
	BSR S_INT
	BSR MUZAK+4

WAIT	CLR.B SYNC
VSYNC	TST.B SYNC
	BEQ.S VSYNC
	CMP.B #$39,$FFFFFC02.W
	BNE.S WAIT
	BSR R_INT
	CLR.L -(A7)
	TRAP #1
S_INT	MOVE.W #$2700,SR
	LEA $FFFFFA00.W,A5
	LEA INTS,A6
	MOVE.B 7(A5),(A6)+
	MOVE.B 9(A5),(A6)+
	MOVE.B $13(A5),(A6)+
	MOVE.B $17(A5),(A6)+
	MOVE.B $19(A5),(A6)+
	MOVE.B $1F(A5),(A6)+
	MOVE.L $70.W,(A6)+
	MOVE.L $134.W,(A6)
	MOVE.B #0,7(A5)
	MOVE.B #0,9(A5)
	MOVE.B #0,$13(A5)
	MOVE.B #0,$19(A5)
	MOVE.L #VBL,$70.W
	MOVE.W #$2300,SR
	RTS
R_INT	MOVE.W #$2700,SR
	LEA $FFFFFA00.W,A5
	LEA INTS,A6
	MOVE.B (A6)+,7(A5)
	MOVE.B (A6)+,9(A5)
	MOVE.B (A6)+,$13(A5)
	MOVE.B (A6)+,$17(A5)
	MOVE.B (A6)+,$19(A5)
	MOVE.B (A6)+,$1F(A5)
	MOVE.L (A6)+,$70.W
	MOVE.L (A6),$134.W
	MOVE.W #$2300,SR
	RTS
VBL	MOVE.W #$700,$FFFF8240.W
	MOVEA.L DIRB,A6
	ST SYNC
	BSR MUZAK+4+4
	MOVE.W #$777,$FFFF8240.W
	RTE
SYNC	DS.W 1
INTS	DS.W 7
MUZAK	
	BRA PREPARE ;LLAMAR AL PRINCIPIO
	BRA PUTMU ;LLAMAR CUANDO YA SE QUIERA LA MUSICA
	BRA P_ROUT ;LLAMAR CADA VBL
	
PREPARE	BSR PREPAM
	BSR INITMU
	BSR PLAYMU
	RTS
PREPAM	LEA $FFFF8200.W,A0
	MOVEP.W 1(A0),D0
	MOVE.W D0,DAERT
	LEA INS(PC),A0
	MOVEQ #(32*4)-1,D0
CLR_INS CLR.L (A0)+
	DBF D0,CLR_INS
	LEA VOICE0,A0
	BSR CLRV
	LEA VOICE1,A0
	BSR CLRV
	LEA VOICE2,A0
	BSR CLRV
	LEA VOICE3,A0
CLRV	MOVEQ #7,D0
CLRVV	CLR.L (A0)+
	DBF D0,CLRVV
	RTS
INITMU	LEA SEQ(PC),A0
	LEA PAT(PC),A1
	LEA NBR_INS(PC),A2
	LEA MUZEXX(PC),A3
	MOVE #$1D8,(A0)
	MOVE #$258,(A1)
	MOVE #15,(A2)
	CMP.L #'M.K.',$438(A3)
	BNE.S RDOC
	MOVE #$3B8,(A0)
	MOVE #$43C,(A1)
	MOVE #31,(A2)
RDOC	LEA MUZEXX(PC),A0
	ADDA.W SEQ(PC),A0
	MOVE.L #$80,D0
	MOVEQ #0,D1
INITMU1	MOVE.L D1,D2
	SUBQ #1,D0
INITMU2	MOVE.B (A0)+,D1
	CMP.B D2,D1
	BGT.S INITMU1
	DBF D0,INITMU2
	ADDQ.B #1,D2
	SWAP D2
	LSR.L #6,D2
	LEA MUZEXX(PC),A0
	ADD.W PAT,A0
	ADD.L D2,A0
	LEA 20+MUZEXX(PC),A1
	LEA 16+INS(PC),A2
	MOVE.W NBR_INS(PC),D0
	SUBQ #1,D0
INITMU3	MOVE.L A0,4(A2)
	MOVEQ #0,D1
	MOVE 22(A1),D1
	LSL.L #1,D1
	MOVE.L D1,(A2)
	ADD.L D1,A0
	MOVEQ #0,D1
	MOVE 24(A1),D1
	BEQ.S INITMU4
	SUBQ #1,D1
INITMU4	MOVE D1,12(A2)
	MOVEQ #0,D1
	MOVE 28(A1),D1
	LSL.L #1,D1
	CMP.L #2,D1
	BNE.S INITMU5
	MOVEQ #0,D1
INITMU5	SWAP D1
	MOVE.L D1,8(A2)
	LEA 30(A1),A1
	LEA 16(A2),A2
	DBF D0,INITMU3
	LEA 16+INS(PC),A0
	MOVEQ #0,D0
	MOVE.W DAERT(PC),D0
	LSL.L #8,D0
	SUB.L #$8000,D0
	MOVE.L D0,A2
	MOVE NBR_INS(PC),D0
	SUBQ #1,D0
REVERSE	MOVE.L	(A0),D1
	BEQ.S ENDREV
	SUBQ.L #1,D1
	MOVE.L D1,D2
	MOVE.L 4(A0),A3
REV_1	MOVE.B (A3)+,D7
	ADD.B #$80,D7
	LSR.B #2,D7
	SUBI.B #$20,D7
	MOVE.B D7,(A2)+
	DBF D1,REV_1
	MOVE.L 4(A0),A3
REV_2	MOVE.B -(A2),(A3)+
	DBF D2,REV_2
ENDREV	LEA 16(A0),A0
	DBF D0,REVERSE
	RTS
PLAYMU	MOVEQ #5,D0
CL_LOOP	MOVE.B D0,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
	DBF D0,CL_LOOP
	MOVE.B #7,$FFFF8800.W
	MOVE.B #$FF,$FFFF8802.W
	MOVE.B #8,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
	MOVE.B #9,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
	MOVE.B #10,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
ON	MOVE.W #$2700,SR
	MOVE.W #6,SPD+2
	MOVE.B #6,SPEED
	MOVE.B #1,POS
	LEA MUZEXX(PC),A0
	ADD SEQ(PC),A0
	LEA -2(A0),A0
	MOVE.B (A0)+,TRK
	MOVE.L A0,MUS+2
	LEA OFF(PC),A0
	LEA OFF(PC),A1
	LEA OFF(PC),A2
	LEA OFF(PC),A3
	MOVEQ #0,D0
	MOVEQ #0,D1
	MOVEQ #0,D2
	MOVEQ #0,D3
	CLR.L V0+2
	CLR.L V1+2
	CLR.L V2+2
	CLR.L V3+2
	CLR.L F0+2
	CLR.L F1+2
	CLR.L F2+2
	CLR.L F3+2
	RTS
PUTMU	LEA SAMVBL,A6
	MOVE.B #0,$FFFFFA19.W
	MOVE.B #61,$FFFFFA1F.W
	MOVE.B #1,$FFFFFA19.W
	BCLR #3,$FFFFFA17.W
	MOVE.L #AMIGA,$134.W
	OR.B #%00100000,$FFFFFA13.W
	OR.B #%00100000,$FFFFFA07.W
	RTS
;AMIGA SOUND CHIP
AMIGA	MOVE.L A0,-(A7)
	MOVE.W D4,-(A7)
	MOVE.L D5,-(A7)
	LEA $FFFF8800.W,A0						;44(5/3)
	MOVE.W (A6)+,D4
	MOVE.L SOUND(PC,D4.W),D5		;18(4/0)
	MOVE.W SOUND+4(PC,D4.W),D4	;14(3/0)
	MOVEP.L	D5,(A0)				;24(2/4)
	MOVEP.W	D4,(A0)				;16(2/2)
	MOVE.L (A7)+,D5
	MOVE.W (A7)+,D4
	MOVE.L (A7)+,A0
	RTE							;20(5/0)
SOUND	DC.W	$80C,$90B,$A09,0,$80C,$90B,$A09,0
	DC.W	$80D,$908,$A08,0,$80B,$90B,$A0B,0
	DC.W	$80D,$909,$A05,0,$80C,$90B,$A08,0
	DC.W	$80D,$909,$A02,0,$80D,$908,$A06,0
	DC.W	$80C,$90B,$A07,0,$80D,$907,$A07,0
	DC.W	$80C,$90B,$A06,0,$80C,$90A,$A09,0
	DC.W	$80B,$90B,$A0A,0,$80C,$90B,$A02,0
	DC.W	$80C,$90B,$A00,0,$80C,$90A,$A08,0
	DC.W	$80D,$906,$A04,0,$80D,$905,$A05,0
	DC.W	$80D,$905,$A04,0,$80C,$909,$A09,0
	DC.W	$80D,$904,$A03,0,$80B,$90B,$A09,0
	DC.W	$80C,$90A,$A05,0,$80B,$90A,$A0A,0
	DC.W	$80C,$909,$A08,0,$80B,$90B,$A08,0
	DC.W	$80C,$90A,$A00,0,$80C,$90A,$A00,0
	DC.W	$80C,$909,$A07,0,$80B,$90B,$A07,0
	DC.W	$80C,$909,$A06,0,$80B,$90B,$A06,0
	DC.W	$80B,$90A,$A09,0,$80B,$90B,$A05,0
	DC.W	$80A,$90A,$A0A,0,$80B,$90B,$A02,0
	DC.W	$80B,$90A,$A08,0,$80C,$907,$A07,0
	DC.W	$80C,$908,$A04,0,$80C,$907,$A06,0
	DC.W	$80B,$909,$A09,0,$80C,$906,$A06,0
	DC.W	$80A,$90A,$A09,0,$80C,$907,$A03,0
	DC.W	$80B,$90A,