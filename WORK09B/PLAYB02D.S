** ESTA VERSION ES COMO LA ANTERIOR
** SOLO QUE NO COMPRUEBA EL FINAL
** DEL SAMPLE, Y ASI GANO TIEMPO...

** LA VERDAD ES QUE AUN NO FUNCIONA
** DEL TODO BIEN POR UN PEQUE¥O ERROR
** SIN IMPORTANCIA... (FACIL DE PONER)

** RED DEVIL & ST_CNX V 1.24

	CLR.L -(A7)
	MOVE.W #$20,-(A7)
	TRAP #1
	LEA $2000,A7

	BSR MUZAK
	BSR S_INT
	BSR MUZAK+4

WAIT	CLR.B SYNC
VSYNC	TST.B SYNC
	BEQ.S VSYNC
	MOVEM.L S_INT,D0-D7
	MOVE.W #$700,$FFFF8240.W
	BSR MUZAK+4+4
	MOVE.W #$777,$FFFF8240.W
	CMP.B #$39,$FFFFFC02.W
	BNE.S WAIT
	BSR R_INT
	CLR.L -(A7)
	TRAP #1
S_INT	MOVE.W #$2700,SR
	LEA $FFFFFA00.W,A5
	LEA INTS,A6
	MOVE.B 7(A5),(A6)+
	MOVE.B 9(A5),(A6)+
	MOVE.B $13(A5),(A6)+
	MOVE.B $17(A5),(A6)+
	MOVE.B $19(A5),(A6)+
	MOVE.B $1F(A5),(A6)+
	MOVE.L $70.W,(A6)+
	MOVE.L $134.W,(A6)
	MOVE.B #0,7(A5)
	MOVE.B #0,9(A5)
	MOVE.B #0,$13(A5)
	MOVE.B #0,$19(A5)
	MOVE.L #VBL,$70.W
	MOVE.W #$2300,SR
	RTS
R_INT	MOVE.W #$2700,SR
	LEA $FFFFFA00.W,A5
	LEA INTS,A6
	MOVE.B (A6)+,7(A5)
	MOVE.B (A6)+,9(A5)
	MOVE.B (A6)+,$13(A5)
	MOVE.B (A6)+,$17(A5)
	MOVE.B (A6)+,$19(A5)
	MOVE.B (A6)+,$1F(A5)
	MOVE.L (A6)+,$70.W
	MOVE.L (A6),$134.W
	MOVE.W #$2300,SR
	RTS
VBL	MOVEA.L DIRB,A6
	ST SYNC
	RTE
SYNC	DS.W 1
INTS	DS.W 7
MUZAK	
	BRA PREPARE ;LLAMAR AL PRINCIPIO
	BRA PUTMU ;LLAMAR CUANDO YA SE QUIERA LA MUSICA
	BRA P_ROUT ;LLAMAR CADA VBL
	
PREPARE	BSR PREPAM
	BSR INITMU
	BSR PLAYMU
	RTS
PREPAM	LEA INS(PC),A0
	MOVEQ #(32*4)-1,D0
CLR_INS CLR.L (A0)+
	DBF D0,CLR_INS
	LEA VOICE0,A0
	BSR CLRV
	LEA VOICE1,A0
	BSR CLRV
	LEA VOICE2,A0
	BSR CLRV
	LEA VOICE3,A0
CLRV	MOVEQ #7,D0
CLRVV	CLR.L (A0)+
	DBF D0,CLRVV
	RTS
INITMU	LEA SEQ(PC),A0
	LEA PAT(PC),A1
	LEA NBR_INS(PC),A2
	LEA MUZEXX(PC),A3
	MOVE #$1D8,(A0)
	MOVE #$258,(A1)
	MOVE #15,(A2)
	CMP.L #'M.K.',$438(A3)
	BNE.S RDOC
	MOVE #$3B8,(A0)
	MOVE #$43C,(A1)
	MOVE #31,(A2)
RDOC	LEA MUZEXX(PC),A0
	ADDA.W SEQ(PC),A0
	MOVE.L #$80,D0
	MOVEQ #0,D1
INITMU1	MOVE.L D1,D2
	SUBQ #1,D0
INITMU2	MOVE.B (A0)+,D1
	CMP.B D2,D1
	BGT.S INITMU1
	DBF D0,INITMU2
	ADDQ.B #1,D2
	SWAP D2
	LSR.L #6,D2
	LEA MUZEXX(PC),A0
	ADD.W PAT,A0
	ADD.L D2,A0
	LEA 20+MUZEXX(PC),A1
	LEA 16+INS(PC),A2
	MOVE.W NBR_INS(PC),D0
	SUBQ #1,D0
INITMU3	MOVE.L A0,4(A2)
	MOVEQ #0,D1
	MOVE 22(A1),D1
	LSL.L #1,D1
	MOVE.L D1,(A2)
	ADD.L D1,A0
	MOVEQ #0,D1
	MOVE 24(A1),D1
	BEQ.S INITMU4
	SUBQ #1,D1
INITMU4	MOVE D1,12(A2)
	MOVEQ #0,D1
	MOVE 28(A1),D1
	LSL.L #1,D1
	CMP.L #2,D1
	BNE.S INITMU5
	MOVEQ #0,D1
INITMU5	SWAP D1
	MOVE.L D1,8(A2)
	LEA 30(A1),A1
	LEA 16(A2),A2
	DBF D0,INITMU3
	LEA 16+INS(PC),A0
	LEA EPRG,A2
	MOVE NBR_INS(PC),D0
	SUBQ #1,D0
REVERSE	MOVE.L	(A0),D1
	BEQ.S ENDREV
	SUBQ.L #1,D1
	MOVE.L D1,D2
	MOVE.L 4(A0),A3
REV_1	MOVE.B (A3)+,D7
	ADD.B #$80,D7
	LSR.B #2,D7
	SUBI.B #$20,D7
	MOVE.B D7,(A2)+
	DBF D1,REV_1
	MOVE.L 4(A0),A3
REV_2	MOVE.B -(A2),(A3)+
	DBF D2,REV_2
ENDREV	LEA 16(A0),A0
	DBF D0,REVERSE
	RTS
PLAYMU	MOVEQ #5,D0
CL_LOOP	MOVE.B D0,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
	DBF D0,CL_LOOP
	MOVE.B #7,$FFFF8800.W
	MOVE.B #$FF,$FFFF8802.W
	MOVE.B #8,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
	MOVE.B #9,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
	MOVE.B #10,$FFFF8800.W
	MOVE.B #0,$FFFF8802.W
ON	MOVE.W #$2700,SR
	MOVE.W #6,SPD+2
	MOVE.B #6,SPEED
	MOVE.B #1,POS
	LEA MUZEXX(PC),A0
	ADD SEQ(PC),A0
	LEA -2(A0),A0
	MOVE.B (A0)+,TRK
	MOVE.L A0,MUS+2
	CLR.L V0+2
	CLR.L V1+2
	CLR.L V2+2
	CLR.L V3+2
	CLR.L F0+2
	CLR.L F1+2
	CLR.L F2+2
	CLR.L F3+2
	RTS
PUTMU	LEA SAMVBL,A6
	MOVE.B #0,$FFFFFA19.W
	MOVE.B #82,$FFFFFA1F.W
	MOVE.B #1,$FFFFFA19.W
	BCLR #3,$FFFFFA17.W
	MOVE.L #AMIGA,$134.W
	OR.B #%00100000,$FFFFFA13.W
	OR.B #%00100000,$FFFFFA07.W
	RTS
;AMIGA SOUND CHIP
AMIGA	MOVE.L D4,-(A7)
	MOVE.L A0,USP
	MOVE.W (A6),D4
	LEA $FFFF8800.W,A0
	MOVE.L SOUND(PC,D4.W),D4
	MOVEP.L D4,(A0)
	MOVE.W (A6)+,D4
	MOVE.W SOUND+4(PC,D4.W),D4
	MOVEP.W D4,(A0)
	MOVE.L USP,A0
	MOVE.L (A7)+,D4
	RTE							;20(5/0)
SOUND	DC.W	$80C,$90B,$A09,0,$80C,$90B,$A09,0
	DC.W	$80D,$908,$A08,0,$80B,$90B,$A0B,0
	DC.W	$80D,$909,$A05,0,$80C,$90B,$A08,0
	DC.W	$80D,$909,$A02,0,$80D,$908,$A06,0
	DC.W	$80C,$90B,$A07,0,$80D,$907,$A07,0
	DC.W	$80C,$90B,$A06,0,$80C,$90A,$A09,0
	DC.W	$80B,$90B,$A0A,0,$80C,$90B,$A02,0
	DC.W	$80C,$90B,$A00,0,$80C,$90A,$A08,0
	DC.W	$80D,$906,$A04,0,$80D,$905,$A05,0
	DC.W	$80D,$905,$A04,0,$80C,$909,$A09,0
	DC.W	$80D,$904,$A03,0,$80B,$90B,$A09,0
	DC.W	$80C,$90A,$A05,0,$80B,$90A,$A0A,0
	DC.W	$80C,$909,$A08,0,$80B,$90B,$A08,0
	DC.W	$80C,$90A,$A00,0,$80C,$90A,$A00,0
	DC.W	$80C,$909,$A07,0,$80B,$90B,$A07,0
	DC.W	$80C,$909,$A06,0,$80B,$90B,$A06,0
	DC.W	$80B,$90A,$A09,0,$80B,$90B,$A05,0
	DC.W	$80A,$90A,$A0A,0,$80B,$90B,$A02,0
	DC.W	$80B,$90A,$A08,0,$80C,$907,$A07,0
	DC.W	$80C,$908,$A04,0,$80C,$907,$A06,0
	DC.W	$80B,$909,$A09,0,$80C,$906,$A06,0
	DC.W	$80A,$90A,$A09,0,$80C,$907,$A03,0
	DC.W	$80B,$90A,$A05,0,$80B,$909,$A08,0
	DC.W	$80B,$90A,$A03,0,$80A,$90A,$A08,0
	DC.W	$80B,$90A,$A00,0,$80B,$909,$A07,0
	DC.W	$80B,$908,$A08,0,$80A,$90A,$A07,0
	DC.W	$80A,$909,$A09,0,$80C,$901,$A01,0
	DC.W	$80A,$90A,$A06,0,$80B,$908,$A07,0
	DC.W	$80A,$90A,$A05,0,$80A,$909,$A08,0
	DC.W	$80A,$90A,$A02,0,$80A,$90A,$A01,0
	DC.W	$80A,$90A,$A00,0,$809,$909,$A09,0
	DC.W	$80A,$908,$A08,0,$80B,$908,$A01,0
	DC.W	$80A,$909,$A06,0,$80B,$907,$A04,0
	DC.W	$80A,$909,$A05,0,$809,$909,$A08,0
	DC.W	$80A,$909,$A03,0,$80A,$908,$A06,0
	DC.W	$80A,$909,$A00,0,$809,$909,$A07,0
	DC.W	$809,$908,$A08,0,$80A,$908,$A04,0
	DC.W	$809,$909,$A06,0,$80A,$908,$A01,0
	DC.W	$809,$909,$A05,0,$809,$908,$A07,0
	DC.W	$808,$908,$A08,0,$809,$909,$A02,0
	DC.W	$809,$908,$A06,0,$809,$909,$A00,0
	DC.W	$809,$907,$A07,0,$808,$908,$A07,0
	DC.W	$809,$907,$A06,0,$809,$908,$A02,0
	DC.W	$808,$908,$A06,0,$809,$906,$A06,0
	DC.W	$808,$907,$A07,0,$808,$908,$A04,0
	DC.W	$808,$907,$A06,0,$808,$908,$A02,0
	DC.W	$807,$907,$A07,0,$808,$906,$A06,0
	DC.W	$808,$907,$A04,0,$807,$907,$A06,0
	DC.W	$808,$906,$A05,0,$808,$906,$A04,0
	DC.W	$807,$906,$A06,0,$807,$907,$A04,0
	DC.W	$808,$905,$A04,0,$806,$906,$A06,0
	DC.W	$807,$906,$A04,0,$807,$905,$A05,0
	DC.W	$806,$906,$A05,0,$806,$906,$A04,0
	DC.W	$806,$905,$A05,0,$806,$906,$A02,0
	DC.W	$806,$905,$A04,0,$805,$905,$A05,0
	DC.W	$806,$905,$A02,0,$805,$905,$A04,0
	DC.W	$805,$904,$A04,0,$805,$905,$A02,0
	DC.W	$804,$904,$A04,0,$804,$904,$A03,0
	DC.W	$804,$904,$A02,0,$804,$903,$A03,0
	DC.W	$803,$903,$A03,0,$803,$903,$A02,0
	DC.W	$803,$902,$A02,0,$802,$902,$A02,0
	DC.W	$802,$902,$A01,0,$801,$901,$A01,0
	DC.W	$802,$901,$A00,0,$801,$901,$A00,0
	DC.W	$801,$900,$A00,0,$800,$900,$A00,0
	DC.W	$80E,$90D,$A0C,0,$80F,$903,$A00,0
	DC.W	$80F,$903,$A00,0,$80F,$903,$A00,0
	DC.W	$80F,$903,$A00,0,$80F,$903,$A00,0
	DC.W	$80F,$903,$A00,0,$80E,$90D,$A0B,0
	DC.W	$80E,$90D,$A0B,0,$80E,$90D,$A0B,0
	DC.W	$80E,$90D,$A0B,0,$80E,$90D,$A0B,0
	DC.W	$80E,$90D,$A0B,0,$80E,$90D,$A0B,0
	DC.W	$80E,$90D,$A0A,0,$80E,$90D,$A0A,0
	DC.W	$80E,$90D,$A0A,0,$80E,$90D,$A0A,0
	DC.W	$80E,$90C,$A0C,0,$80E,$90D,$A00,0
	DC.W	$80D,$90D,$A0D,0,$80D,$90D,$A0D,0
	DC.W	$80D,$90D,$A0D,0,$80D,$90D,$A0D,0
	DC.W	$80D,$90D,$A0D,0,$80D,$90D,$A0D,0
	DC.W	$80E,$90C,$A0B,0,$80E,$90C,$A0B,0
	DC.W	$80E,$90C,$A0B,0,$80E,$90C,$A0B,0
	DC.W	$80E,$90C,$A0B,0,$80E,$90C,$A0B,0
	DC.W	$80E,$90C,$A0B,0,$80E,$90C,$A0B,0
	DC.W	$80E,$90C,$A0A,0,$80E,$90C,$A0A,0
	DC.W	$80E,$90C,$A0A,0,$80E,$90C,$A0A,0
	DC.W	$80D,$90D,$A0C,0,$80D,$90D,$A0C,0
	DC.W	$80E,$90C,$A09,0,$80E,$90C,$A09,0
	DC.W	$80E,$90C,$A05,0,$80E,$90C,$A00,0
	DC.W	$80E,$90C,$A00,0,$80E,$90B,$A0B,0
	DC.W	$80E,$90B,$A0B,0,$80E,$90B,$A0B,0
	DC.W	$80E,$90B,$A0B,0,$80E,$90B,$A0A,0
	DC.W	$80E,$90B,$A0A,0,$80E,$90B,$A0A,0
	DC.W	$80D,$90D,$A0B,0,$80D,$90D,$A0B,0
	DC.W	$80D,$90D,$A0B,0,$80E,$90B,$A09,0
	DC.W	$80E,$90B,$A09,0,$80E,$90B,$A09,0
	DC.W	$80D,$90C,$A0C,0,$80D,$90D,$A0A,0
	DC.W	$80E,$90B,$A07,0,$80E,$90B,$A00,0
	DC.W	$80E,$90B,$A00,0,$80D,$90D,$A09,0
	DC.W	$80D,$90D,$A09,0,$80E,$90A,$A09,0
	DC.W	$80D,$90D,$A08,0,$80D,$90D,$A07,0
	DC.W	$80D,$90D,$A04,0,$80D,$90D,$A00,0
	DC.W	$80E,$90A,$A04,0,$80E,$909,$A09,0
	DC.W	$80E,$909,$A09,0,$80D,$90C,$A0B,0
	DC.W	$80E,$909,$A08,0,$80E,$909,$A08,0
	DC.W	$80E,$909,$A07,0,$80E,$908,$A08,0
	DC.W	$80E,$909,$A01,0,$80C,$90C,$A0C,0
	DC.W	$80D,$90C,$A0A,0,$80E,$908,$A06,0
	DC.W	$80E,$907,$A07,0,$80E,$908,$A00,0
	DC.W	$80E,$907,$A05,0,$80E,$906,$A06,0
	DC.W	$80D,$90C,$A09,0,$80E,$905,$A05,0
	DC.W	$80E,$904,$A04,0,$80D,$90C,$A08,0
	DC.W	$80D,$90B,$A0B,0,$80E,$900,$A00,0
	DC.W	$80D,$90C,$A06,0,$80D,$90C,$A05,0
	DC.W	$80D,$90C,$A02,0,$80C,$90C,$A0B,0
	DC.W	$80C,$90C,$A0B,0,$80D,$90B,$A0A,0
	DC.W	$80D,$90B,$A0A,0,$80D,$90B,$A0A,0
	DC.W	$80D,$90B,$A0A,0,$80C,$90C,$A0A,0
	DC.W	$80C,$90C,$A0A,0,$80C,$90C,$A0A,0
	DC.W	$80D,$90B,$A09,0,$80D,$90B,$A09,0
	DC.W	$80D,$90A,$A0A,0,$80D,$90A,$A0A,0
	DC.W	$80D,$90A,$A0A,0,$80C,$90C,$A09,0
	DC.W	$80C,$90C,$A09,0,$80C,$90C,$A09,0
	DC.W	$80D,$90B,$A06,0,$80C,$90B,$A0B,0
	DC.W	$80C,$90C,$A08,0,$80D,$90B,$A00,0
	DC.W	$80D,$90B,$A00,0,$80C,$90C,$A07,0
	DC.W	$80C,$90C,$A06,0,$80C,$90C,$A05,0
	DC.W	$80C,$90C,$A03,0,$80C,$90C,$A01,0
	DC.W	$80C,$90B,$A0A,0,$80D,$90A,$A05,0
	DC.W	$80D,$90A,$A04,0,$80D,$90A,$A02,0
	DC.W	$80D,$909,$A08,0,$80D,$909,$A08,0
P_ROUT	MOVEM.L REX,D0-A5
	SUBQ.B	#1,SPEED
	BEQ.S	PLAY
	JSR EFFECT
END_VBL	JSR SYNTH
	MOVEM.L D0-A5,REX
	RTS
REX	DS.L 8
	DC.L OFF
	DC.L OFF
	DC.L OFF
	DC.L OFF
	DS.L 2
PLAY	MOVEM.L	D0-D1/A0-A5,-(SP)
SPD	MOVE.B	#6,SPEED
	SUBQ.B	#1,POS
	BNE.S NOPAT
	MOVE.B #64,POS
	ADDQ.L #1,MUS+2
	SUBQ.B #1,TRK
	BMI RESTART
	MOVEQ #0,D0
MUS	MOVE.B $0,D0
	SWAP D0
	LSR.L #6,D0
	LEA MUZEXX(PC),A0
	ADD PAT(PC),A0
	ADD.L D0,A0
	MOVE.L A0,ADD_IN_PAT
NOPAT	MOVE.L ADD_IN_PAT(PC),A0
	LEA FRQ(PC),A1
	LEA INS(PC),A2
	LEA COMMAND(PC),A3
	LEA VOICE0(PC),A4
	BSR LOAD_VOICE
	LEA VOICE1(PC),A4
	BSR LOAD_VOICE
	LEA VOICE2(PC),A4
	BSR LOAD_VOICE
	LEA VOICE3(PC),A4
	BSR LOAD_VOICE
	MOVE.L A0,ADD_IN_PAT
	MOVEM.L (SP)+,D0-D1/A0-A5
	MOVEM.L	D4/A5,-(SP)
	LEA VOICE0(PC),A5
	TST.B 20(A5)
	BEQ.S CONT0
	MOVE.L (A5),D0
	MOVE.L 4(A5),A0
	MOVE.L 8(A5),D4
	MOVE.L D4,L0+2
	MOVE.L 12(A5),D4
	MOVE.L D4,V0+2
	MOVE.L 16(A5),D4
	MOVE.L D4,F0+2
CONT0	CLR.B 20(A5)
	LEA VOICE1(PC),A5
	TST.B 20(A5)
	BEQ.S CONT1
	MOVE.L (A5),D1
	MOVE.L 4(A5),A1
	MOVE.L 8(A5),D4
	MOVE.L D4,L1+2
	MOVE.L 12(A5),D4
	MOVE.L D4,V1+2
	MOVE.L 16(A5),D4
	MOVE.L D4,F1+2
CONT1	CLR.B 20(A5)
	LEA VOICE2(PC),A5
	TST.B 20(A5)
	BEQ.S CONT2
	MOVE.L (A5),D2
	MOVE.L 4(A5),A2
	MOVE.L 8(A5),D4
	MOVE.L D4,L2+2
	MOVE.L 12(A5),D4
	MOVE.L D4,V2+2
	MOVE.L 16(A5),D4
	MOVE.L D4,F2+2
CONT2	CLR.B 20(A5)
	LEA VOICE3(PC),A5
	TST.B 20(A5)
	BEQ.S CONT3
	MOVE.L (A5),D3
	MOVE.L 4(A5),A3
	MOVE.L 8(A5),D4
	MOVE.L D4,L3+2
	MOVE.L 12(A5),D4
	MOVE.L D4,V3+2
	MOVE.L 16(A5),D4
	MOVE.L D4,F3+2
CONT3	CLR.B 20(A5)
	MOVEM.L	(SP)+,D4/A5
	BRA END_VBL
LOAD_VOICE
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE	D0,30(A4)
	MOVE	(A0)+,D0
	BEQ.S	WCOMAND
	BTST	#12,D0
	BEQ.S	CONT_FRQ
	AND		#$FFF,D0
	MOVE	#$100,D1
CONT_FRQ
	MOVE.B	#1,20(A4)
	MOVE	D0,24(A4)
	ADD		D0,D0
	ADD		D0,D0
	MOVE.L (A1,D0.W),D0
	MOVE.L D0,12(A4)
	TST.L 16(A4)
	BEQ.S CONTL
	MOVE.L D0,16(A4)
CONTL	OR.B (A0),D1
	AND #$FF0,D1
	BEQ.S WCOMAND
	MOVE.L 12(A4),16(A4)
	MOVE.L 0(A2,D1.W),(A4)
	MOVE.L 4(A2,D1.W),4(A4)
	MOVE.L 8(A2,D1.W),8(A4)
	BNE.S REPEAT
	CLR.L 16(A4)
REPEAT
WCOMAND	MOVE (A0)+,D0
	MOVE.B D0,D1
	AND.W #$F00,D0
	LSR #6,D0
	MOVE.L (A3,D0.W),A5
	JMP (A5)
NCOMAND	RTS
ARPG	TST.B D1
	BEQ.S NARPG
	MOVE.B #0,22(A4)
	MOVE.B D1,23(A4)
	MOVE.B #1,21(A4)		*ARPEGGIO COUNTER
	MOVE #1,30(A4)
NARPG	RTS
P_UP	MOVE.B	#1,22(A4)
	MOVE.B	D1,23(A4)
	MOVE	#1,30(A4)
	RTS
P_DOWN	MOVE.B	#2,22(A4)
	MOVE.B	D1,23(A4)
	MOVE	#1,30(A4)
	RTS
POSJUMP	LEA MUZEXX(PC),A5
	ADD.W SEQ(PC),A5
	LEA -1(A5),A5
	MOVE.B #1,POS
	MOVE.L A5,D0
	ADD.L D1,D0
	MOVE.L D0,MUS+2
	MOVE.B -1(A5),D0
	SUB.W D1,D0
	MOVE.B D0,TRK
	RTS
SETVOL	TST.B	D1
	BNE.S	NCHANGE			*NO REAL TIME VOLUME VARIATION
	CLR.L	12(A4)				*IN THIS VERSION! MAYBE
	MOVE.B	#1,20(A4)			*SOME OTHER DAY...
NCHANGE	RTS
P_BREAK	MOVE.B	#1,POS
	RTS
SETFILT	RTS
S_SPEED	MOVE.B	D1,SPD+3
	MOVE.B	D1,SPEED
	RTS
COMMAND	DC.L ARPG,P_UP,P_DOWN,NCOMAND
	DC.L NCOMAND,NCOMAND,NCOMAND,NCOMAND
	DC.L NCOMAND,NCOMAND,NCOMAND,POSJUMP
	DC.L SETVOL,P_BREAK,SETFILT,S_SPEED
EFFECT	MOVEM.L	D4-D6/A0/A4-A5,-(SP)
	LEA FRQ(PC),A5
	LEA VOICE0(PC),A0
	TST 30(A0)
	BEQ.S CONTE
	BSR DOEFF
	MOVE.L	26(A0),V0+2
	TST.L	F0+2
	BEQ.S	CONTE
	MOVE.L	26(A0),F0+2
CONTE	LEA		VOICE1(PC),A0
	TST		30(A0)
	BEQ.S	CONT_EFFECT2
	BSR		DOEFF
	MOVE.L	26(A0),V1+2
	TST.L	F1+2
	BEQ.S	CONT_EFFECT2
	MOVE.L	26(A0),F1+2
CONT_EFFECT2
	LEA		VOICE2(PC),A0
	TST		30(A0)
	BEQ.S	CONT_EFFECT3
	BSR		DOEFF
	MOVE.L	26(A0),V2+2
	TST.L	F2+2
	BEQ.S	CONT_EFFECT3
	MOVE.L	26(A0),F2+2
CONT_EFFECT3
	LEA		VOICE3(PC),A0
	TST		30(A0)
	BEQ.S	CONT_EFFECT4
	BSR		DOEFF
	MOVE.L	26(A0),V3+2
	TST.L	F3+2
	BEQ.S	CONT_EFFECT4
	MOVE.L	26(A0),F3+2
CONT_EFFECT4
	MOVEM.L	(SP)+,D4-D6/A0/A4-A5
	RTS
DOEFF	MOVE.B	22(A0),D4
	BEQ.S	ARPEGGIO_ROUT
	CMP.B	#1,D4
	BEQ.S	PORTUP
	CMP.B	#2,D4
	BEQ.S	PORTDOWN
	RTS
PORTUP	MOVEQ	#0,D4
	MOVE.B	23(A0),D4
	MOVE	24(A0),D5
	SUB		D4,D5
	CMP		#$71,D5
	BPL.S	OK_PORTUP
	MOVEQ	#$71,D5
OK_PORTUP
	MOVE	D5,24(A0)
	ADD		D5,D5
	ADD		D5,D5
	MOVE.L	(A5,D5),26(A0)
	RTS
PORTDOWN
	MOVEQ	#0,D4
	MOVE.B	23(A0),D4
	MOVE	24(A0),D5
	ADD		D4,D5
	CMP		#$358,D5
	BMI.S	OK_PORTDOWN
	MOVE	#$358,D5
OK_PORTDOWN
	MOVE	D5,24(A0)
	ADD		D5,D5
	ADD		D5,D5
	MOVE.L	(A5,D5),26(A0)
	RTS
ARPEGGIO_ROUT
	MOVE.B	21(A0),D4
	CMP.B	#1,D4
	BEQ.S	ARP_ROUT1
	CMP.B	#2,D4
	BEQ.S	ARP_ROUT2
	CMP.B	#3,D4
	BEQ.S	ARP_ROUT3
	CMP.B	#4,D4
	BEQ.S	ARP_ROUT1
	CMP.B	#5,D4
	BEQ.S	ARP_ROUT2
	RTS
ARP_ROUT1
	MOVEQ	#0,D4
	MOVE.B	23(A0),D4
	LSR.B	#4,D4
	BRA.S	ARP_ROUT
ARP_ROUT2
	MOVEQ	#0,D4
	MOVE.B	23(A0),D4
	AND.B	#$0F,D4
	BRA.S	ARP_ROUT
ARP_ROUT3
	MOVE	24(A0),D6
	BRA.S	END_ARP_ROUT2
ARP_ROUT
	ADD		D4,D4
	MOVE	24(A0),D5
	LEA		ARPEGGIO_DATA(PC),A4
ARP_LOOP
	CMP		(A4),D5
	BEQ.S	END_ARP_ROUT1
	LEA		2(A4),A4
	BRA.S	ARP_LOOP
END_ARP_ROUT1
	MOVE	(A4,D4),D6
END_ARP_ROUT2
	ADD		D6,D6
	ADD		D6,D6
	MOVE.L	(A5,D6),26(A0)
	ADDQ.B	#1,21(A0)
	RTS
RESTART
	MOVEM.L	(SP)+,D0-D1/A0-A5
	MOVE	#6,SPD+2 
	MOVE.B	#6,SPEED
	MOVE.B	#1,POS
	LEA		MUZEXX,A0
	ADD		SEQ,A0
	LEA		-2(A0),A0
	MOVE.B	(A0)+,TRK
	MOVE.L	A0,MUS+2
	LEA		OFF,A0
	LEA		OFF,A1
	LEA		OFF,A2
	LEA		OFF,A3
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVEQ	#0,D3
	CLR.L	V0+2
	CLR.L	V1+2
	CLR.L	V2+2
	CLR.L	V3+2
	CLR.L	F0+2
	CLR.L	F1+2
	CLR.L	F2+2
	CLR.L	F3+2
	BRA		PLAY
BVBL	EQU 7500/50 ;(10KHZ/50HZ)	
INCSAM	DC.W 0
SYNTH	EOR.W #BVBL*2,INCSAM
	MOVE.W INCSAM,D6
	LEA SAMVBL(PC),A5
	LEA 0(A5,D6.W),A5
	LEA DDAT(PC),A4
	MOVEM.L D0-D3,(A4)
V0	MOVE.L #0,D0
V1	MOVE.L #0,D1
V2	MOVE.L #0,D2
V3	MOVE.L #0,D3
	MOVE.W #BVBL-1,D7
GENSAM	
AV0	SUB.L	D0,(A4)
	BMI.S	L0
AV1	SUB.L	D1,4*1(A4)
	BMI.S	L1
AV2	SUB.L	D2,4*2(A4)
	BMI.S	L2
AV3	SUB.L	D3,4*3(A4)
	BMI.S	L3
OUT	MOVEQ #0,D4
	MOVE.W (A4),D5
	MOVE.B 0(A0,D5.W),D4			;14(3/0)
	MOVE.W 4*1(A4),D5
	ADD.B  0(A1,D5.W),D4
	MOVE.W 4*2(A4),D5
	ADD.B  0(A2,D5.W),D4			;14(3/0)
	MOVE.W 4*3(A4),D5
	ADD.B  0(A3,D5.W),D4			;14(3/0)
	LSL.W #3,D4
	MOVE.W D4,(A5)+
	DBF D7,GENSAM
	LEA -BVBL*2(A5),A5
	MOVE.L A5,DIRB
	MOVEM.L (A4),D0-D3
	RTS
L0	MOVE.L	#0,(A4)
F0	MOVE.L	#0,D0
	BRA.S AV1
L1	MOVE.L	#0,4*1(A4)
F1	MOVE.L	#0,D1
	BRA.S V2
L2	MOVE.L	#0,4*2(A4)
F2	MOVE.L	#0,D2
	BRA V3
L3	MOVE.L	#0,4*3(A4)
F3	MOVE.L	#0,D3
	BRA.S OUT
DDAT	DS.L 4
DIRB	DC.L SAMVBL
SAMVBL	DS.W BVBL*2
OFF			DC.L	0
SPEED		DC.B	0
POS			DC.B	0
TRK			DC.B	0
SEQ			DS.W	1
PAT			DS.W	1
NBR_INS		DS.W	1
FRQ			INCBIN	'7,5_KHZ.FRQ',0
ARPEGGIO_DATA	DC.W	$0358,$0328,$02FA,$02D0,$02A6,$0280,$025C
		DC.W	$023A,$021A,$01FC,$01E0,$01C5,$01AC,$0194,$017D
		DC.W	$0168,$0153,$0140,$012E,$011D,$010D,$00FE,$00F0
		DC.W	$00E2,$00D6,$00CA,$00BE,$00B4,$00AA,$00A0,$0097
		DC.W	$008F,$0087,$007F,$0078,$0071,$0000,$0000,$0000
VOICE0	DS.L	8
VOICE1	DS.L	8
VOICE2	DS.L	8
VOICE3	DS.L	8
ADD_IN_PAT	DS.L	1
INS	DS.L	32*4
MUZEXX	INCBIN 'OH-NO.MOD'
EPRG
	
	
	