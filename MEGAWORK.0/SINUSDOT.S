** SINUS DOTS: RUTINA DE MOVIMIENTOS
** DADOS POR FUNCIONES TRIGONOMETRICAS
** UN SEN(X) OTRO DE (Y) Y UNA TABLA
** DE CIRCULOS A AADIR A LA POSICION
** DADA. 

** (C) 1990 RED DEVIL

PI	EQU $2000
GRAD	EQU PI/4
MAX	EQU PI/2
MAY	EQU PI/4
LBAL	EQU 2
NBALLS	EQU 340
BASE 	EQU $F0000
	BRA CODE
TABLE	INCBIN 'MEGASIN.RED'
CODE	PEA 0
	MOVE.W #$20,-(A7)
	TRAP #1
	LEA $2000,A7
	BSR SETSIN
	BSR P_BALL
	BSR SETNUM
	BSR CLS
	BSR SSCREEN
	BSR SINT
	MOVE.W #0,$FFFF8240.W
	MOVE.W #$777,$FFFF8242.W
ME	CLR.B SYNC
VSYNC	TST.B SYNC
	BEQ.S VSYNC
	*MOVE.W #$070,$FFFF8240.W
	BSR INPUTK
	BSR CHGSC
	BSR BOSPR
	BSR PLAT
	BSR CALCTR
	BSR PTABLE
	*MOVE.W #$00,$FFFF8240.W
	CMP.B #$39,$FFFFFC02.W
	BNE.S ME
	BSR GINT
	CLR.L -(A7)
	TRAP #1
PLAT	LEA BOR(PC),A0
	LEA BORR+(NBALLS*2)(PC),A1
	REPT NBALLS/20
	MOVEM.L (A0)+,D0-D7/A2-A3
	MOVEM.L D0-D7/A2-A3,-(A1)
	ENDR
	RTS
CHGSC	LEA SCREEN(PC),A0
	MOVE.L (A0),D0
	BCHG #15,D0
	MOVE.L D0,(A0)
	LSR.L #8,D0
	MOVE.B D0,$FFFF8203.W
	LSR.W #8,D0
	MOVE.B D0,$FFFF8201.W
	RTS
BOSPR	MOVEA.L SCREEN,A1
	MOVEQ #0,D1
	LEA BORR(PC),A2
	REPT NBALLS
	MOVE.W (A2)+,D0
	MOVE.W D1,0(A1,D0.W) 
	ENDR
	RTS	
INPUTK	MOVE.B $FFFFFC02.W,D0
	LEA FUNC(PC),A0
SEARCHX	MOVE.W (A0)+,D1
	BPL.S NVETE
	RTS
NVETE	ADDQ.L #4,A0
	CMP.B D0,D1
	BNE.S SEARCHX
	MOVE.L -4(A0),A0
	LEA POSITBL(PC),A1
	LEA SINUSVAR(PC),A2
	JMP (A0)
FUNC	
KEU	MACRO T,F
	DC.W \1
	DC.L \2
	ENDM
	KEU $48,REXP
	KEU $50,SUXP
	KEU $4B,REXI
	KEU $4D,SUXI
	DC.W -1
SUXP	ADDQ.W #2,(A1)
	AND.W #$F,(A1)
	RTS
REXP	SUBQ.W #2,(A1)
	AND.W #$F,(A1)
	RTS
SUXI	MOVE.W (A1),D0
	ADD.W D0,D0
	MOVE.W FTABLE(PC,D0.W),D1
	MOVE.W FTABLE+2(PC,D0.W),D2
	ADD.W D1,0(A2,D2.W)
	RTS
REXI	MOVE.W (A1),D0
	ADD.W D0,D0
	MOVE.W FTABLE(PC,D0.W),D1
	MOVE.W FTABLE+2(PC,D0.W),D2
	SUB.W D1,0(A2,D2.W)
	RTS
FTABLE	DC.W 4,2
	DC.W 4,16
	DC.W 2,0
	DC.W 2,14
	DC.W 4,6
	DC.W 4,10
	DC.W 2,4
	DC.W 4,12
PTABLE	MOVEQ #0,D7
	LEA NUM(PC),A0
	MOVEA.L SCREEN,A1
	LEA SINUSVAR(PC),A2
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B (A2),D0
	MOVE.B 1(A2),D1
	LEA 2+(8*8)(A1),A4
	BSR PNUM
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B 2(A2),D0
	MOVE.B 3(A2),D1
	LEA 2+(8*3)(A1),A4
	BSR PNUM
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B 4(A2),D0
	MOVE.B 5(A2),D1
	LEA 2+(8*18)(A1),A4
	BSR PNUM
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B 6(A2),D0
	MOVE.B 7(A2),D1
	LEA 2+(8*13)(A1),A4
	BSR PNUM
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B 14(A2),D0
	MOVE.B 15(A2),D1
	LEA 2+(8*8)+(160*8)(A1),A4
	BSR PNUM
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B 16(A2),D0
	MOVE.B 17(A2),D1
	LEA 2+(8*3)+(160*8)(A1),A4
	BSR PNUM
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B 12(A2),D0
	MOVE.B 13(A2),D1
	LEA 2+(8*18)+(160*8)(A1),A4
	BSR PNUM
	MOVEQ #0,D1
	MOVEQ #0,D0
	MOVE.B 10(A2),D0
	MOVE.B 11(A2),D1
	LEA 2+(8*13)+(160*8)(A1),A4
	BSR PNUM
	MOVEQ #-1,D1
	LEA TBLPOSI(PC),A0
	MOVE.W -2(A0),D0
	ADDA.W 0(A0,D0.W),A1
	MOVE.W D1,(A1)
	MOVE.W D1,8(A1)
	RTS	
PNUM	LSL.W #4,D0
	LSL.W #4,D1
	LEA 0(A0,D0.W),A3
	MOVE.W (A3)+,(A4)
	MOVE.W (A3)+,(160*1)(A4)
	MOVE.W (A3)+,(160*2)(A4)
	MOVE.W (A3)+,(160*3)(A4)
	MOVE.W (A3),(160*4)(A4)
	MOVE.W D7,(160*6)(A4)
	LEA 0(A0,D1.W),A3
	MOVE.W (A3)+,8(A4)
	MOVE.W (A3)+,8+(160*1)(A4)
	MOVE.W (A3)+,8+(160*2)(A4)
	MOVE.W (A3)+,8+(160*3)(A4)
	MOVE.W (A3),8+(160*4)(A4)
	MOVE.W D7,8+(160*6)(A4)
	RTS	
POSITBL	DC.W 0
TBLPOSI	DC.W 2+(8*3)+(160*6),2+(8*3)+(160*14)
	DC.W 2+(8*8)+(160*6),2+(8*8)+(160*14)
	DC.W 2+(8*13)+(160*6),2+(8*13)+(160*14)
	DC.W 2+(8*18)+(160*6),2+(8*18)+(160*14)
SINUSVAR
POSX	DC.W 0
POSY	DC.W 0
INCX	DC.W 0*2
INCY	DC.W 0*4
POCC	DC.W 0
INKC	DC.W 0*4
INDC	DC.W 0*4
INDX	DC.W 0*2
INDY	DC.W 0*4
BOR	REPT NBALLS
	DC.W 0
	ENDR
BORR	REPT NBALLS
	DC.W 0
	ENDR
CALCTR	LEA TABLE(PC),A0
	LEA (MAX*2)(A0),A1
	LEA (MAY*4)(A1),A2
	LEA SINUSVAR(PC),A4
	LEA BOR(PC),A5
	MOVEA.L SCREEN,A3
	MOVE.L 2*2(A4),D1
	MOVE.L (A4),D0
	MOVE.W #(PI-1),D4
	SWAP D4
	MOVE.W #(PI-1),D4
	ADD.W D1,D0
	SWAP D0
	SWAP D1
	ADD.W D1,D0
	SWAP D0
	SWAP D1
	AND.L D4,D0
	MOVE.L D0,(A4)
	MOVE.W 5*2(A4),D3
	MOVE.W 4*2(A4),D1
	ADD.W D3,D1
	AND.W D4,D1
	MOVE.W D1,4*2(A4)
	MOVE.L 7*2(A4),D2
	MOVE.W 6*2(A4),D3
	MOVE.W #LBAL*16,D7
	REPT NBALLS
	BSR CLALC
	ENDR
	RTS
CLALC	ADD.W D2,D0
	AND.W D4,D0
	MOVE.W 0(A1,D0.W),D6
	MOVE.W 2(A1,D0.W),D5
	SWAP D0
	SWAP D2
	ADD.W D2,D0
	AND.W D4,D0
	ADD.W 0(A0,D0.W),D5 
	SWAP D2
	SWAP D0
	ADD.W D3,D1
	AND.W D4,D1
	ADD.W 0(A2,D1.W),D6
	ADD.W 2(A2,D1.W),D5
	CMP.W D6,D7
	BGT.S NORES
	SUB.W D7,D6
	ADDQ.W #8,D5
NORES	MOVE.W D5,(A5)+ 
	MOVE.W BALL(PC,D6.W),D6
	OR.W D6,0(A3,D5.W)
	RTS
BALL	DS.W 16
SETSIN	LEA TABLE(PC),A6
	LEA (A6),A0
	MOVE.W #MAX-1,D0
	BSR SETYSIN
	LEA (MAX*2)(A6),A0
	MOVE.W #MAY-1,D0
	BSR SETXSIN
	LEA (MAX*2)+(MAY*4)(A6),A0
	MOVE.W #GRAD-1,D0
	BSR S_XYSIN
	RTS
SETYSIN	MOVEQ #0,D7
	MOVE.W (A0),D7
	MULU #$A0,D7
	MOVE.W D7,(A0)+
	DBF D0,SETYSIN
	RTS
SETXSIN	MOVEQ #0,D7
	MOVE.W (A0),D7
	DIVU #16,D7
	MOVE.W D7,D6
	CLR.W D7
	SWAP D7
	MULU #LBAL,D7
	MOVE.W D7,(A0)+
	LSL.W #3,D6
	MOVE.W D6,(A0)+
	DBF D0,SETXSIN
	RTS
S_XYSIN	MOVEQ #0,D7
	MOVE.W (A0),D7
	DIVU #16,D7
	MOVE.W D7,D6
	CLR.W D7
	SWAP D7
	MULU #LBAL,D7
	MOVE.W D7,(A0)+
	MULU #8,D6
	MOVEQ #0,D7
	MOVE.W (A0),D7
	MULU #160,D7
	ADD.W D7,D6
	MOVE.W D6,(A0)+
	DBF D0,S_XYSIN
	RTS
P_BALL	LEA BALL(PC),A1
	MOVE.W #$8000,D0
	MOVEQ #16-1,D1
ROTPONT	MOVE.W D0,(A1)+
	LSR.W #1,D0
	DBF D1,ROTPONT
	RTS
CLS	LEA BASE,A0
	LEA BASE+($8000)+($7D00),A1
LKJ	CLR.L (A0)+
	CMPA.L A0,A1
	BGT.S LKJ
	RTS
PRINT	LEA SET+(2*16)(PC),A2
	MOVEQ #0,D1
MOVOLOP	MOVEQ #0,D0
	MOVE.B (A0)+,D0
	BPL.S NORES1
	RTS
NORES1	TST.B D0
	BNE.S LETUSG1
	LEA 160*7(A1),A1
	BRA.S MOVOLOP
LETUSG1	BSR SCHIT
	MULU #6,D1
	LEA 0(A2,D1.W),A3
	MOVE.B (A3)+,(A1)
	MOVE.B (A3)+,160*1(A1)
	MOVE.B (A3)+,160*2(A1)
	MOVE.B (A3)+,160*3(A1)
	MOVE.B (A3)+,160*4(A1)
	MOVE.B (A3)+,160*5(A1)
SSND	MOVEQ #0,D0
	MOVE.B (A0)+,D0
	BPL.S NORES2
	RTS
NORES2	TST.B D0
	BNE.S LETUSG2
	LEA 160*7(A1),A1
	BRA.S SSND
LETUSG2	BSR SCHIT
	MULU #6,D1
	LEA 0(A2,D1.W),A3
	MOVE.B (A3)+,1(A1)
	MOVE.B (A3)+,1+(160*1)(A1)
	MOVE.B (A3)+,1+(160*2)(A1)
	MOVE.B (A3)+,1+(160*3)(A1)
	MOVE.B (A3)+,1+(160*4)(A1)
	MOVE.B (A3)+,1+(160*5)(A1)
	ADDQ.L #8,A1
	BRA.S MOVOLOP
SCHIT	LEA (A5),A3
	MOVE.W #-1,D1
SEARCH	MOVE.B (A3)+,D2
	BMI.S NOFOUND
	ADDQ.W #1,D1
	CMP.W D0,D2
	BNE.S SEARCH
NOFOUND	RTS
SETNUM	MOVE.W #256-1,D7
	LEA NUMESET(PC),A5
	LEA NUM(PC),A6
D7LOP	LEA NUMCAD(PC),A0
	LEA BASE,A1
	BSR PRINT
	LEA BASE,A1
	MOVE.W (A1),(A6)+
	MOVE.W 160*1(A1),(A6)+
	MOVE.W 160*2(A1),(A6)+
	MOVE.W 160*3(A1),(A6)+
	MOVE.W 160*4(A1),(A6)+
	MOVE.W 160*5(A1),(A6)+
	CLR.L (A6)+
	LEA NUX(PC),A0
	ADDQ.B #1,1(A0)
	CMP.B #$10,1(A0)
	BLT.S MORE
	CLR.B 1(A0)
	ADDQ.B #1,(A0)
MORE	MOVE.B (A0)+,D0
	ADD.B #'0',D0
	MOVE.B D0,NUMCAD
	MOVE.B (A0),D0
	ADD.B #'0',D0
	MOVE.B D0,NUMCAD+1
	DBF D7,D7LOP
	RTS
NUM	DS.W 256*8
SSCREEN	LEA CHARSET(PC),A5
	LEA TEXT1,A0
	LEA BASE+2,A1
	BSR PRINT
	LEA TEXT1,A0
	LEA BASE+2+($8000),A1
	BSR PRINT
	RTS
SINT	MOVE.W #$2700,SR
	LEA INTS(PC),A0
	LEA $FFFFFA00.W,A1
	MOVE.L $70.W,(A0)+
	MOVE.L $120.W,(A0)+
	MOVE.L $134.W,(A0)+
	MOVEM.L $FFFFF8240.W,D0-D7
	MOVEM.L D0-D7,(A0)
	LEA 8*4(A0),A0
	MOVE.B 7(A1),(A0)+
	MOVE.B 9(A1),(A0)+
	MOVE.B $13(A1),(A0)+
	MOVE.B $17(A1),(A0)+
	MOVE.B $19(A1),(A0)+
	MOVE.B $1F(A1),(A0)+
	MOVE.L #VBL,$70.W
	CLR.B 7(A1)
	CLR.B 9(A1)
	MOVE.W #$2300,SR
	RTS
GINT	MOVE.W #$2700,SR
	LEA INTS(PC),A0
	LEA $FFFFFA00.W,A1
	MOVE.L (A0)+,$70.W
	MOVE.L (A0)+,$120.W
	MOVE.L (A0)+,$134.W
	MOVEM.L (A0)+,D0-D7
	MOVEM.L D0-D7,$FFFF8240.W
	MOVE.B (A0)+,7(A1)
	MOVE.B (A0)+,9(A1)
	MOVE.B (A0)+,$13(A1)
	MOVE.B (A0)+,$17(A1)
	MOVE.B (A0)+,$19(A1)
	MOVE.B (A0)+,$1F(A1)
	MOVE.W #$2300,SR
	RTS
VBL	ST SYNC
	RTE
INTS	DS.L 11
	DS.B 6
NUX	DC.B 0,0 
NUMCAD	DC.B '00',-1
SYNC	DS.B 1
TEXT1	DC.B ' XPOS:     YPOS:     XINC:     YINC:    ',0
	DC.B ' XIND:     YIND:     ZINC:     ZIND:    ',-1
SCREEN	DC.L BASE
CHARSET	DC.B 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789[]$%/\@*()-+=:"!,.?>< ',-1
NUMESET	DC.B '9'+1,'9'+2,'9'+3,'9'+4,'9'+5,'9'+6,'GHIJKLMNOPQRSTUVWXYZ0123456789',-1
SET	INCBIN 'CHARSET.BIN'
EPRG



